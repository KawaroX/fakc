# ai_processor.py
import yaml
import re
import datetime
import json
from openai import OpenAI
from typing import List, Dict, Any, Optional

class AIProcessor:
    def __init__(self, api_key: str, base_url: str, model: str):
        self.client = OpenAI(api_key=api_key, base_url=base_url)
        self.model = model
    
    # ç¬¬ä¸€æ­¥ï¼šçŸ¥è¯†ç‚¹åˆ†æä¸æ¶æ„æ„å»º
    def extract_knowledge_points_step1(self, subtitle_content: str, metadata: Dict[str, str]) -> Dict:
        """æ‰§è¡Œç¬¬ä¸€æ­¥åˆ†æï¼Œè¾“å‡ºJSONç»“æ„"""
        prompt = self.STEP1_PROMPT_TEMPLATE.format(
            subtitle_content=subtitle_content,
            subject=metadata['subject'],
            source=metadata['source'],
            course_url=metadata.get('course_url', 'æœªæä¾›')
        )
        
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                response_format={"type": "json_object"},
                temperature=0,
            )
            
            return json.loads(response.choices[0].message.content)
        except Exception as e:
            print(f"âŒ ç¬¬ä¸€æ­¥åˆ†æå¤±è´¥: {e}")
            return {}

    # ç¬¬äºŒæ­¥ï¼šè¯¦ç»†ç¬”è®°æ•´ç†
    def generate_notes_step2(self, analysis_result: Dict, subtitle_content: str, metadata: Dict[str, str]) -> List[Dict[str, Any]]:
        """æ ¹æ®ç¬¬ä¸€æ­¥ç»“æœç”Ÿæˆæœ€ç»ˆç¬”è®°"""
        prompt = self.STEP2_PROMPT_TEMPLATE.format(
            analysis_result=json.dumps(analysis_result, ensure_ascii=False),
            subtitle_content=subtitle_content,
            subject=metadata['subject'],
            source=metadata['source'],
            course_url=metadata.get('course_url', '')
        )
        
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0,
            )
            
            return self._parse_ai_response(response.choices[0].message.content)
        except Exception as e:
            print(f"âŒ ç¬¬äºŒæ­¥ç¬”è®°ç”Ÿæˆå¤±è´¥: {e}")
            return []

    # æ—§ç‰ˆå…¼å®¹æ–¹æ³•ï¼ˆå•æ­¥å¤„ç†ï¼‰
    def extract_all_knowledge_points(self, subtitle_content: str, metadata: Dict[str, str]) -> List[Dict[str, Any]]:
        """ä¸€æ¬¡æ€§å¤„ç†æ•´ä¸ªå­—å¹•ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰"""
        # ä½¿ç”¨æ–°ä¸¤æ­¥æ³•å¤„ç†
        analysis = self.extract_knowledge_points_step1(subtitle_content, metadata)
        if not analysis:
            return []
        return self.generate_notes_step2(analysis, subtitle_content, metadata)
    
    # ç¬¬ä¸€æ­¥æç¤ºè¯æ¨¡æ¿
    STEP1_PROMPT_TEMPLATE = """\
ä½ æ˜¯ä¸“ä¸šçš„æ³•è€ƒè¯¾ç¨‹åˆ†æä¸“å®¶ã€‚è¯·æ·±åº¦åˆ†æä»¥ä¸‹å­—å¹•å†…å®¹ï¼Œè¯†åˆ«æ‰€æœ‰çŸ¥è¯†ç‚¹å¹¶æ„å»ºè¯¦ç»†çš„å­¦ä¹ æ¶æ„ã€‚

å­—å¹•å†…å®¹ï¼š
{subtitle_content}

è¯¾ç¨‹ä¿¡æ¯ï¼š
- ç§‘ç›®ï¼š{subject}
- æ¥æºï¼š{source}
- è¯¾ç¨‹é“¾æ¥ï¼š{course_url}

## åˆ†æç›®æ ‡

ä½ éœ€è¦ä¸ºåç»­çš„ç¬”è®°æ•´ç†AIæä¾›å®Œæ•´çš„æŒ‡å¯¼ï¼Œç¡®ä¿ï¼š
1. **æ— é—æ¼**ï¼šè¯†åˆ«æ¯ä¸ªç‹¬ç«‹çš„æ³•å¾‹æ¦‚å¿µ
2. **ä¿ç»†èŠ‚**ï¼šä¿ç•™è€å¸ˆçš„é‡è¦è¡¨è¿°ã€å¼ºè°ƒã€ä¸¾ä¾‹
3. **å»ºå…³è”**ï¼šæ˜ç¡®æ¦‚å¿µé—´çš„é€»è¾‘å…³ç³»
4. **ä¼ é£æ ¼**ï¼šå‡†ç¡®ä¼ è¾¾è€å¸ˆçš„æ•™å­¦ç‰¹ç‚¹

## çŸ¥è¯†ç‚¹è¯†åˆ«åŸåˆ™

**è¶…ç»†åŒ–æ‹†åˆ†æ ‡å‡†**ï¼š
- æ¯ä¸ªæœ‰ç‹¬ç«‹åç§°çš„æ³•å¾‹æ¦‚å¿µéƒ½è¦å•ç‹¬è¯†åˆ«
- æ¯ä¸ªå¯èƒ½åœ¨è€ƒè¯•ä¸­å•ç‹¬è€ƒæŸ¥çš„çŸ¥è¯†ç‚¹éƒ½è¦æ‹†åˆ†
- æ¯ä¸ªåœ¨å®åŠ¡ä¸­æœ‰ç‹¬ç«‹åº”ç”¨çš„æ¦‚å¿µéƒ½è¦ç‹¬ç«‹å¤„ç†
- å®å¯æ‹†åˆ†è¿‡ç»†ï¼Œä¸è¦åˆå¹¶ç‹¬ç«‹æ¦‚å¿µ

**ç‰¹åˆ«å…³æ³¨**ï¼š
- æ³•å¾‹æ¡æ–‡ä¸­çš„å…·ä½“è§„å®š
- æ„æˆè¦ä»¶çš„æ¯ä¸ªè¦ç´ 
- ä¸åŒæƒ…å½¢ä¸‹çš„å¤„ç†åŸåˆ™
- ä¾‹å¤–è§„å®šå’Œç‰¹æ®Šæƒ…å†µ
- è€å¸ˆç‰¹åˆ«å¼ºè°ƒçš„è¦ç‚¹

## è¾“å‡ºè¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š

{{
  "course_overview": {{
    "main_topic": "ä¸»è¦è¯é¢˜",
    "total_duration": "æ€»æ—¶é•¿",
    "teaching_style": "è€å¸ˆæ•™å­¦é£æ ¼æè¿°ï¼ˆä¸¾ä¾‹å¤š/ç†è®ºå¼º/å®åŠ¡å¯¼å‘ç­‰ï¼‰",
    "key_emphasis": ["è€å¸ˆåå¤å¼ºè°ƒçš„è¦ç‚¹1", "è¦ç‚¹2"],
    "difficulty_level": "éš¾åº¦ç­‰çº§"
  }},
  
  "knowledge_points": [
    {{
      "id": "KP001",
      "concept_name": "æ¦‚å¿µåç§°",
      "concept_type": "å®šä¹‰æ€§æ¦‚å¿µ/ç¨‹åºæ€§çŸ¥è¯†/åˆ¤æ–­æ ‡å‡†/æ„æˆè¦ä»¶/æ³•æ¡è§„å®š/å®åŠ¡ç»éªŒ",
      "time_range": "MM:SS.mm-MM:SS.mm",
      "importance_level": "é«˜/ä¸­/ä½",
      
      "core_definition": {{
        "teacher_original": "è€å¸ˆçš„åŸå§‹è¡¨è¿°ï¼ˆå°½å¯èƒ½ä¿æŒåŸè¯ï¼‰",
        "key_keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],
        "context": "å®šä¹‰çš„ä¸Šä¸‹æ–‡èƒŒæ™¯"
      }},
      
      "detailed_content": {{
        "main_explanation": "ä¸»è¦è§£é‡Šå†…å®¹",
        "examples": [
          {{
            "example_content": "å…·ä½“ä¾‹å­å†…å®¹", 
            "teacher_comment": "è€å¸ˆå¯¹ä¾‹å­çš„ç‚¹è¯„æˆ–å¼ºè°ƒ"
          }}
        ],
        "special_notes": ["ç‰¹åˆ«æ³¨æ„äº‹é¡¹1", "æ³¨æ„äº‹é¡¹2"],
        "common_mistakes": ["æ˜“é”™ç‚¹1", "æ˜“é”™ç‚¹2"],
        "memory_tips": "è®°å¿†æŠ€å·§æˆ–å£è¯€"
      }},
      
      "exam_relevance": {{
        "exam_frequency": "å¸¸è€ƒ/å¶è€ƒ/åŸºç¡€",
        "question_types": ["é€‰æ‹©é¢˜", "æ¡ˆä¾‹é¢˜", "è®ºè¿°é¢˜"],
        "key_test_points": ["è€ƒç‚¹1", "è€ƒç‚¹2"]
      }},
      
      "relationships": {{
        "parent_concept": "ä¸Šä½æ¦‚å¿µID",
        "sub_concepts": ["å­æ¦‚å¿µID1", "å­æ¦‚å¿µID2"],
        "related_concepts": ["ç›¸å…³æ¦‚å¿µID1", "ç›¸å…³æ¦‚å¿µID2"],
        "contrast_concepts": ["å¯¹æ¯”æ¦‚å¿µID1", "å¯¹æ¯”æ¦‚å¿µID2"]
      }}
    }}
  ],
  
  "concept_structure": {{
    "hierarchy": "æ¦‚å¿µå±‚æ¬¡ç»“æ„çš„æ–‡å­—æè¿°",
    "main_logic_flow": "ä¸»è¦é€»è¾‘è„‰ç»œ",
    "cross_references": [
      {{
        "concept1": "æ¦‚å¿µID1",
        "concept2": "æ¦‚å¿µID2", 
        "relationship": "å…³ç³»ç±»å‹ï¼ˆåŒ…å«/å¯¹æ¯”/ä¾èµ–/å¹¶åˆ—ç­‰ï¼‰"
      }}
    ]
  }},
  
  "teaching_insights": {{
    "teacher_preferences": "è€å¸ˆçš„æ•™å­¦åå¥½ï¼ˆçˆ±ä¸¾ä¾‹/é‡ç†è®º/å¼ºè°ƒå®åŠ¡ç­‰ï¼‰",
    "emphasis_pattern": "å¼ºè°ƒæ¨¡å¼ï¼ˆé‡å¤è¯´æ˜/å¯¹æ¯”åˆ†æ/æ¡ˆä¾‹è§£é‡Šç­‰ï¼‰",
    "student_attention": ["éœ€è¦ç‰¹åˆ«æ³¨æ„çš„å­¦ä¹ è¦ç‚¹"],
    "practical_tips": ["å®åŠ¡å»ºè®®æˆ–ç»éªŒåˆ†äº«"]
  }}
}}

## ç‰¹åˆ«è¦æ±‚

1. **ä¿æŒåŸæ±åŸå‘³**ï¼šå°½å¯èƒ½ä¿ç•™è€å¸ˆçš„åŸå§‹è¡¨è¿°ï¼Œç‰¹åˆ«æ˜¯å®šä¹‰ã€å¼ºè°ƒã€ä¸¾ä¾‹
2. **æ—¶é—´æˆ³ç²¾ç¡®**ï¼šæ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½è¦æœ‰å‡†ç¡®çš„æ—¶é—´èŒƒå›´ï¼Œæ ¼å¼ä¸º[MM:SS.mm-MM:SS.mm]
3. **å…³ç³»æ¸…æ™°**ï¼šæ¦‚å¿µé—´çš„å…³ç³»è¦å‡†ç¡®ï¼Œé¿å…å¾ªç¯å¼•ç”¨
4. **ç»†èŠ‚ä¸°å¯Œ**ï¼šä¸ºåç»­ç¬”è®°æ•´ç†æä¾›å……åˆ†çš„ä¿¡æ¯åŸºç¡€
5. **IDå‘½å**ï¼šçŸ¥è¯†ç‚¹IDä½¿ç”¨KP001ã€KP002æ ¼å¼ï¼Œä¾¿äºå¼•ç”¨

è¯·å¼€å§‹åˆ†æï¼Œè¾“å‡ºå®Œæ•´çš„JSONç»“æ„ã€‚"""

    # ç¬¬äºŒæ­¥æç¤ºè¯æ¨¡æ¿
    STEP2_PROMPT_TEMPLATE = """\
ä½ æ˜¯ä¸“ä¸šçš„æ³•è€ƒç¬”è®°æ•´ç†ä¸“å®¶ã€‚è¯·æ ¹æ®å‰ä¸€æ­¥çš„åˆ†æç»“æœå’ŒåŸå§‹å­—å¹•å†…å®¹ï¼Œç”Ÿæˆå®Œæ•´çš„Obsidianç¬”è®°ã€‚

## è¾“å…¥å†…å®¹

**çŸ¥è¯†ç‚¹åˆ†æç»“æœ**ï¼š
{analysis_result}

**åŸå§‹å­—å¹•å†…å®¹**ï¼š
{subtitle_content}

**è¯¾ç¨‹ä¿¡æ¯**ï¼š
- ç§‘ç›®ï¼š{subject}
- æ¥æºï¼š{source}
- è¯¾ç¨‹é“¾æ¥ï¼š{course_url}

## æ•´ç†ç›®æ ‡

åŸºäºçŸ¥è¯†ç‚¹åˆ†æï¼Œä¸ºæ¯ä¸ªè¯†åˆ«å‡ºçš„æ¦‚å¿µåˆ›å»ºå®Œæ•´çš„Obsidianç¬”è®°ï¼Œå®ç°ï¼š
1. **çŸ¥è¯†å›¾è°±èŠ‚ç‚¹**ï¼šæ¯ä¸ªç¬”è®°æ˜¯å›¾è°±ä¸­çš„æ¸…æ™°èŠ‚ç‚¹
2. **Wikiç™¾ç§‘æ¡ç›®**ï¼šç‹¬ç«‹å®Œæ•´ï¼Œå¯å•ç‹¬é˜…è¯»ç†è§£
3. **é”™é¢˜å®šä½ç´¢å¼•**ï¼šç²¾å‡†åŒ¹é…è€ƒè¯•çŸ¥è¯†ç‚¹

## æ ¸å¿ƒåŸåˆ™

**å®Œå…¨ä¾æ®åˆ†æç»“æœ**ï¼šä¸¥æ ¼æŒ‰ç…§ç¬¬ä¸€æ­¥è¯†åˆ«çš„çŸ¥è¯†ç‚¹åˆ—è¡¨ç”Ÿæˆç¬”è®°ï¼Œä¸é—æ¼ã€ä¸æ–°å¢

**ä¿æŒæ•™å­¦åŸå‘³**ï¼šå……åˆ†åˆ©ç”¨åˆ†æç»“æœä¸­çš„teacher_originalã€examplesã€teacher_commentç­‰ä¿¡æ¯

**ç»“æ„æ™ºèƒ½è®¾è®¡**ï¼šæ ¹æ®æ¯ä¸ªæ¦‚å¿µçš„ç‰¹ç‚¹ï¼ˆconcept_typeï¼‰å’Œè¯¦ç»†å†…å®¹è®¾è®¡æœ€é€‚åˆçš„ç« èŠ‚ç»“æ„

**åŒé“¾ç²¾ç¡®å»ºç«‹**ï¼šä½¿ç”¨åˆ†æç»“æœä¸­çš„relationshipsä¿¡æ¯å»ºç«‹å‡†ç¡®çš„æ¦‚å¿µå…³è”

## ç¬”è®°ç”Ÿæˆè§„åˆ™

**å¿…éœ€ç« èŠ‚**ï¼šæ¯ä¸ªç¬”è®°å¿…é¡»åŒ…å«
- æ ¸å¿ƒå®šä¹‰
- è®°å¿†è¦ç‚¹  
- ç›¸å…³æ¦‚å¿µ

**è‡ªç”±ç« èŠ‚**ï¼šæ ¹æ®æ¦‚å¿µç‰¹ç‚¹æ™ºèƒ½åˆ›é€ 
- æ„æˆè¦ä»¶ç±»ï¼šè¯¦ç»†åˆ—ä¸¾å„ä¸ªè¦ä»¶
- ç¨‹åºæ€§çŸ¥è¯†ï¼šæ­¥éª¤æˆ–æµç¨‹è¯´æ˜
- åˆ¤æ–­æ ‡å‡†ç±»ï¼šåˆ¤æ–­æ–¹æ³•å’Œæ ‡å‡†
- å®åŠ¡ç»éªŒç±»ï¼šå®é™…åº”ç”¨å’Œæ³¨æ„äº‹é¡¹
- æ³•æ¡è§„å®šç±»ï¼šæ¡æ–‡å†…å®¹å’Œé€‚ç”¨æƒ…å†µ

**ç« èŠ‚è®¾è®¡æŒ‡å¯¼**ï¼š
```
concept_type = "æ„æˆè¦ä»¶" â†’ å¯è®¾è®¡"æ„æˆè¦ä»¶è¯¦è§£"ç« èŠ‚
concept_type = "ç¨‹åºæ€§çŸ¥è¯†" â†’ å¯è®¾è®¡"æ“ä½œæµç¨‹"ç« èŠ‚  
concept_type = "åˆ¤æ–­æ ‡å‡†" â†’ å¯è®¾è®¡"åˆ¤æ–­æ–¹æ³•"ç« èŠ‚
concept_type = "å®åŠ¡ç»éªŒ" â†’ å¯è®¾è®¡"å®åŠ¡åº”ç”¨"ç« èŠ‚
concept_type = "æ³•æ¡è§„å®š" â†’ å¯è®¾è®¡"æ¡æ–‡è§£è¯»"ç« èŠ‚
```

## å†…å®¹å¡«å……ç­–ç•¥

**æ ¸å¿ƒå®šä¹‰**ï¼šä¼˜å…ˆä½¿ç”¨teacher_originalï¼Œè¡¥å……contextä¿¡æ¯

**è¯¦ç»†å†…å®¹**ï¼šå……åˆ†åˆ©ç”¨main_explanationã€examplesã€special_notes

**è®°å¿†è¦ç‚¹**ï¼šç»“åˆmemory_tipsã€key_keywordsã€common_mistakes

**ç›¸å…³æ¦‚å¿µ**ï¼šä¸¥æ ¼æŒ‰ç…§relationshipsä¸­çš„ä¿¡æ¯å»ºç«‹åŒé“¾

**æ¡ˆä¾‹ä¸¾ä¾‹**ï¼šè¯¦ç»†å±•å¼€examplesä¸­çš„å†…å®¹ï¼Œä¿ç•™teacher_comment

## æŠ€æœ¯è§„èŒƒ

**YAMLå…ƒæ•°æ®**ï¼š
```yaml
title: "ã€{subject}ã€‘{{concept_name}}"
aliases: ["{{concept_name}}", "å…¶ä»–åˆ«å"]
tags: ["{subject}", "æ ¹æ®concept_typeç¡®å®š", "æ ¹æ®importance_levelç¡®å®š"]
source: "{source}"
course_url: "{course_url}"
time_range: "{{time_range}}"
subject: "{subject}"
exam_importance: "{{importance_level}}"
concept_id: "{{id}}"
created: "å½“å‰æ—¶é—´"
```

**åŒé“¾æ ¼å¼**ï¼š
- å¼•ç”¨æ ¼å¼ï¼š[[ã€{subject}ã€‘æ¦‚å¿µå|æ¦‚å¿µå]]
- æ ¹æ®relationshipsç²¾ç¡®å»ºç«‹å…³è”

**æ—¶é—´æˆ³æ ¼å¼**ï¼š
- ä¸¥æ ¼ä½¿ç”¨[MM:SS.mm]æ ¼å¼
- ä»time_rangeä¸­æå–

## è¾“å‡ºæ ¼å¼

æ¯ä¸ªç¬”è®°ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

```
=== NOTE_SEPARATOR ===
YAML:
---
[YAMLå…ƒæ•°æ®]
---
CONTENT:
# ã€{subject}ã€‘{{concept_name}}

## æ ¸å¿ƒå®šä¹‰

â° [{{time_range}}]
[åŸºäºteacher_originalå’Œcore_definitionçš„å†…å®¹]

## [æ™ºèƒ½åˆ›é€ çš„ç« èŠ‚æ ‡é¢˜]
[åŸºäºdetailed_contentå’Œconcept_typeçš„å…·ä½“å†…å®¹]

## è®°å¿†è¦ç‚¹

ğŸ”® [åŸºäºmemory_tipsçš„å…³é”®ç‚¹] â€” [ç®€æ´è§£é‡Š]
ğŸ“± [åŸºäºexamplesçš„åº”ç”¨åœºæ™¯] â€” [å…¸å‹æƒ…å†µ]
ğŸ’¡ [åŸºäºcommon_mistakesçš„æé†’] â€” [æ˜“é”™æç¤º]

## ç›¸å…³æ¦‚å¿µ

[åŸºäºrelationshipsç²¾ç¡®å»ºç«‹çš„åŒé“¾åˆ—è¡¨]

---
*è§†é¢‘æ—¶é—´æ®µï¼š{{time_range}}*

=== NOTE_SEPARATOR ===
```

## è´¨é‡è¦æ±‚

1. **ä¸€ä¸€å¯¹åº”**ï¼šanalysis_resultä¸­æ¯ä¸ªknowledge_pointéƒ½è¦ç”Ÿæˆå¯¹åº”ç¬”è®°
2. **ä¿¡æ¯å®Œæ•´**ï¼šå……åˆ†åˆ©ç”¨åˆ†æç»“æœä¸­çš„æ‰€æœ‰æœ‰ç”¨ä¿¡æ¯
3. **é€»è¾‘æ¸…æ™°**ï¼šæ¦‚å¿µé—´å…³ç³»å‡†ç¡®ï¼ŒåŒé“¾æœ‰æ„ä¹‰
4. **ç»†èŠ‚ä¸°å¯Œ**ï¼šæ¡ˆä¾‹è¯¦ç»†ï¼Œè¯´æ˜å……åˆ†
5. **æ ¼å¼æ ‡å‡†**ï¼šä¸¥æ ¼éµå¾ªæŠ€æœ¯è§„èŒƒ

è¯·å¼€å§‹æ ¹æ®åˆ†æç»“æœç”Ÿæˆå®Œæ•´çš„Obsidianç¬”è®°ï¼ŒæŒ‰åºå·é¡ºåºå¤„ç†æ¯ä¸ªçŸ¥è¯†ç‚¹ï¼Œä¸é—æ¼ä»»ä½•æ¦‚å¿µã€‚ä¸¥æ ¼æŒ‰ç…§æ ¼å¼è¾“å‡ºï¼Œä¸éœ€è¦é¢å¤–è¯´æ˜ã€‚"""
    
    def enhance_concept_relationships(self, all_notes: List[Dict], existing_concepts: Dict) -> List[Dict]:
        """è®©AIåˆ†ææ‰€æœ‰ç¬”è®°å†…å®¹ï¼Œå¢å¼ºæ¦‚å¿µå…³ç³»"""
        if not all_notes:
            return all_notes
            
        prompt = self._build_enhancement_prompt(all_notes, existing_concepts)
        
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
            )
            
            enhanced_notes = self._parse_enhancement_response(response.choices[0].message.content, all_notes)
            return enhanced_notes
        except Exception as e:
            print(f"âš ï¸ æ¦‚å¿µå…³ç³»å¢å¼ºå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ç»“æœ: {e}")
            return all_notes
    
    def enhance_single_note_concepts(self, note_content: str, note_title: str, existing_concepts: Dict) -> Optional[Dict]:
        """å¢å¼ºå•ä¸ªç¬”è®°çš„æ¦‚å¿µå…³ç³»"""
        prompt = self._build_single_note_enhancement_prompt(note_content, note_title, existing_concepts)
        
        try:
            if self.model == "gemini-2.5-flash":
                response = self.client.chat.completions.create(
                    reasoning_effort="medium",
                    model=self.model,
                    messages=[{"role": "user", "content": prompt}],
                )
            else:
                response = self.client.chat.completions.create(
                    model=self.model,
                    messages=[{"role": "user", "content": prompt}],
                )

            return self._parse_single_note_enhancement_response(
                response.choices[0].message.content, 
                note_content
            )
        except Exception as e:
            print(f"âŒ AIå¢å¼ºå•ä¸ªç¬”è®°å¤±è´¥: {e}")
            return None
    
    def _build_extraction_prompt(self, subtitle_content: str, metadata: Dict[str, str]) -> str:
        """æ„å»ºæå–çŸ¥è¯†ç‚¹çš„æç¤ºè¯"""
        return f"""ä½ æ˜¯ä¸“ä¸šçš„æ³•è€ƒç¬”è®°æ•´ç†ä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹å­—å¹•å†…å®¹ï¼Œæå–æ‰€æœ‰ç‹¬ç«‹çš„çŸ¥è¯†ç‚¹ï¼Œä¸ºæ¯ä¸ªçŸ¥è¯†ç‚¹ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„Obsidianç¬”è®°ã€‚

å­—å¹•å†…å®¹ï¼š
{subtitle_content}

è¯¾ç¨‹ä¿¡æ¯ï¼š
- ç§‘ç›®ï¼š{metadata['subject']}
- æ¥æºï¼š{metadata['source']}
- è¯¾ç¨‹é“¾æ¥ï¼š{metadata.get('course_url', 'æœªæä¾›')}

## é¡¹ç›®ç›®æ ‡å’Œæ„ä¹‰

æˆ‘ä»¬æ­£åœ¨æ„å»ºä¸€ä¸ªå®Œæ•´çš„æ³•è€ƒçŸ¥è¯†ä½“ç³»ï¼Œå…·æœ‰ä¸‰ä¸ªæ ¸å¿ƒç›®æ ‡ï¼š

**ç›®æ ‡ä¸€ï¼šæ„å»ºObsidiançŸ¥è¯†å›¾è°±**
é€šè¿‡åŒé“¾ç¬”è®°ç³»ç»Ÿï¼Œå°†æ³•è€ƒæ‰€æœ‰çŸ¥è¯†ç‚¹è¿æ¥æˆä¸€ä¸ªå¯è§†åŒ–çš„çŸ¥è¯†ç½‘ç»œã€‚æ¯ä¸ªæ¦‚å¿µéƒ½æ˜¯å›¾è°±ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›¸å…³æ¦‚å¿µé€šè¿‡åŒé“¾å½¢æˆçŸ¥è¯†è„‰ç»œï¼Œå¸®åŠ©ç†è§£æ¦‚å¿µé—´çš„é€»è¾‘å…³ç³»ã€‚

**ç›®æ ‡äºŒï¼šå»ºç«‹æ³•è€ƒWikiç™¾ç§‘**
åˆ›å»ºç±»ä¼¼ç»´åŸºç™¾ç§‘çš„æ³•è€ƒçŸ¥è¯†ä½“ç³»ï¼Œæ¯ä¸ªæ³•å¾‹æ¦‚å¿µéƒ½æœ‰ç‹¬ç«‹è¯¦ç»†çš„æ¡ç›®ã€‚å­¦ä¹ è€…å¯ä»¥ä»ä»»ä½•ä¸€ä¸ªæ¦‚å¿µå‡ºå‘ï¼Œé€šè¿‡åŒé“¾è·³è½¬åˆ°ç›¸å…³æ¦‚å¿µï¼Œå®ç°çŸ¥è¯†çš„æ·±åº¦æ¢ç´¢å’Œå…³è”å­¦ä¹ ã€‚

**ç›®æ ‡ä¸‰ï¼šé”™é¢˜å¿«é€Ÿå®šä½ç³»ç»Ÿ**
å½“æ•´ç†é”™é¢˜æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ°æ¶‰åŠçš„å…·ä½“çŸ¥è¯†ç‚¹ã€‚è¿™è¦æ±‚æ¯ä¸ªå¯èƒ½åœ¨è€ƒè¯•ä¸­ç‹¬ç«‹å‡ºç°çš„æ¦‚å¿µéƒ½è¦æœ‰å¯¹åº”çš„ç¬”è®°ï¼Œä¾¿äºé”™é¢˜åˆ†ææ—¶ç²¾å‡†å…³è”åˆ°ç›¸å…³çŸ¥è¯†ç‚¹ã€‚

## æ ¸å¿ƒæŒ‡å¯¼åŸåˆ™

**å†…å®¹å®Œæ•´æ€§**ï¼šä¿ç•™æ‰€æœ‰æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è€å¸ˆçš„ä¾‹å­ã€æ¡ˆä¾‹ã€è§£é‡Šã€å¼ºè°ƒã€å®åŠ¡ç»éªŒç­‰ã€‚æ¯ä¸ªç¬”è®°éƒ½è¦åƒä¸€ä¸ªå®Œæ•´çš„ç™¾ç§‘æ¡ç›®ï¼Œå®å¯è¯¦ç»†ä¹Ÿä¸è¦é—æ¼é‡è¦å†…å®¹ã€‚

**ç»†åˆ†ä¼˜å…ˆç­–ç•¥**ï¼šæåŠ›å€¾å‘äºå°†çŸ¥è¯†ç‚¹æ‹†åˆ†å¾—æ›´ç»†è‡´ã€‚æƒ³è±¡ä½ åœ¨ä¸ºä¸€ä¸ªæ³•è€ƒWikiåˆ›å»ºæ¡ç›®ï¼Œæ¯ä¸ªå…·æœ‰ç‹¬ç«‹åç§°ã€å®šä¹‰æˆ–è€ƒæŸ¥ä»·å€¼çš„æ¦‚å¿µéƒ½åº”è¯¥æœ‰ç‹¬ç«‹çš„æ¡ç›®ã€‚è¿™ç§ç»†åˆ†æ˜¯æ„å»ºçŸ¥è¯†å›¾è°±å’Œå®ç°é”™é¢˜ç²¾å‡†å®šä½çš„åŸºç¡€ã€‚

**åŒé“¾è¿æ¥é€»è¾‘**ï¼šå°†æ¯ä¸ªç¬”è®°è§†ä¸ºçŸ¥è¯†å›¾è°±ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡åŒé“¾ä¸å…¶ä»–èŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚ä¸Šä½æ¦‚å¿µé€šè¿‡åŒé“¾è¿æ¥ä¸‹ä½æ¦‚å¿µï¼Œç›¸å…³æ¦‚å¿µç›¸äº’å¼•ç”¨ï¼Œå½¢æˆç«‹ä½“çš„çŸ¥è¯†ç½‘ç»œã€‚

**Wikiå¼å®Œæ•´æ€§**ï¼šæ¯ä¸ªç¬”è®°éƒ½åº”è¯¥èƒ½å¤Ÿç‹¬ç«‹é˜…è¯»å’Œç†è§£ï¼Œå°±åƒç»´åŸºç™¾ç§‘çš„æ¡ç›®ä¸€æ ·ã€‚è¯»è€…ä»ä»»ä½•ä¸€ä¸ªç¬”è®°å¼€å§‹ï¼Œéƒ½èƒ½é€šè¿‡åŒé“¾æ·±å…¥å­¦ä¹ ç›¸å…³çŸ¥è¯†ã€‚

**è€ƒè¯•å¯¼å‘ç²¾ç¡®æ€§**ï¼šè€ƒè™‘æ¯ä¸ªçŸ¥è¯†ç‚¹åœ¨è€ƒè¯•ä¸­çš„ç‹¬ç«‹æ€§ã€‚å¦‚æœæŸä¸ªæ¦‚å¿µå¯èƒ½åœ¨é€‰æ‹©é¢˜ã€æ¡ˆä¾‹é¢˜æˆ–è®ºè¿°é¢˜ä¸­å•ç‹¬å‡ºç°ï¼Œå°±åº”è¯¥æœ‰ç‹¬ç«‹çš„ç¬”è®°ï¼Œä¾¿äºé”™é¢˜æ•´ç†æ—¶ç²¾ç¡®å…³è”ã€‚

**ç»“æ„æ™ºèƒ½æ€§**ï¼šå®Œå…¨æ ¹æ®å®é™…å†…å®¹å†³å®šç¬”è®°ç»“æ„ã€‚ä½ éœ€è¦åˆ†æè€å¸ˆçš„è®²è¯¾é‡ç‚¹å’Œæ–¹å¼ï¼Œç„¶åè®¾è®¡æœ€é€‚åˆçš„ç« èŠ‚ç»“æ„æ¥ç»„ç»‡ä¿¡æ¯ã€‚ä¸è¦è¢«ä»»ä½•é¢„è®¾çš„æ¨¡æ¿é™åˆ¶ã€‚

**ç†è§£å¯¼å‘**ï¼šä»¥å¸®åŠ©å­¦ç”Ÿç†è§£å’ŒæŒæ¡çŸ¥è¯†ä¸ºç›®æ ‡ï¼Œé€‰æ‹©æœ€æœ‰åˆ©äºå­¦ä¹ çš„ä¿¡æ¯ç»„ç»‡æ–¹å¼ï¼ŒæŒ‰ç…§éœ€è¦é€‰æ‹©è¡¨æ ¼ã€mermaidç­‰æ–¹å¼è¾…åŠ©è¡¨è¾¾ï¼Œè¿™ç‚¹ååˆ†é‡è¦ã€‚

## çŸ¥è¯†ç‚¹è¯†åˆ«å’Œæ‹†åˆ†ç­–ç•¥

**è¶…ç»†åŒ–æ‹†åˆ†æ ‡å‡†**ï¼š
- æ¯ä¸ªæœ‰ç‹¬ç«‹åç§°çš„æ³•å¾‹æ¦‚å¿µï¼ˆæ— è®ºå¤§å°ï¼‰éƒ½åº”è¯¥ç‹¬ç«‹æˆç¬”è®°
- æ¯ä¸ªå¯èƒ½åœ¨è€ƒè¯•ä¸­å•ç‹¬æåŠçš„çŸ¥è¯†ç‚¹éƒ½è¦ç‹¬ç«‹å¤„ç†
- æ¯ä¸ªåœ¨å®åŠ¡ä¸­æœ‰ç‹¬ç«‹åº”ç”¨åœºæ™¯çš„æ¦‚å¿µéƒ½è¦æ‹†åˆ†
- å®å¯æ‹†åˆ†è¿‡ç»†ä¹Ÿä¸è¦åˆå¹¶ç‹¬ç«‹æ¦‚å¿µ

**å›¾è°±èŠ‚ç‚¹è®¾è®¡çš„æŠ€æœ¯ç»†èŠ‚**ï¼š
- èŠ‚ç‚¹è¦æœ‰æ˜ç¡®çš„ä¸»é¢˜è¾¹ç•Œï¼Œä¸èƒ½æ¨¡ç³Šä¸æ¸…
- èŠ‚ç‚¹é—´é€šè¿‡åŒé“¾å½¢æˆæœ‰å‘æˆ–æ— å‘çš„è¿æ¥å…³ç³»
- é¿å…åˆ›å»ºè¿‡äºåºå¤§çš„"è¶…çº§èŠ‚ç‚¹"ï¼Œè¿™ä¼šç ´åå›¾è°±çš„æ¸…æ™°æ€§

**é”™é¢˜åŒ¹é…çš„å…·ä½“åœºæ™¯**ï¼š
- é”™é¢˜æ¶‰åŠ"å–„æ„å–å¾—"ï¼Œåº”è¯¥èƒ½ç›´æ¥æ‰¾åˆ°å¯¹åº”ç¬”è®°
- é”™é¢˜æ¶‰åŠ"è¿”è¿˜åŸç‰©è¯·æ±‚æƒçš„æ„æˆè¦ä»¶"ï¼Œæ¯ä¸ªè¦ä»¶éƒ½åº”è¯¥æœ‰å¯¹åº”çš„è¯¦ç»†è¯´æ˜
- é”™é¢˜æ¶‰åŠæŸä¸ªå…·ä½“åŸåˆ™çš„é€‚ç”¨ï¼Œè¯¥åŸåˆ™åº”è¯¥æœ‰ç‹¬ç«‹ä¸”å®Œæ•´çš„ç¬”è®°

## å­—å¹•æ ¼å¼å¤„ç†

**æ”¯æŒæ ¼å¼**ï¼šä¸»è¦æ¥å—lrcæ ¼å¼å’Œsrtæ ¼å¼çš„å­—å¹•æ–‡ä»¶ï¼Œè¿™äº›æ ¼å¼åŒ…å«æ—¶é—´æˆ³ä¿¡æ¯ã€‚ä¹Ÿå¯èƒ½æ¥æ”¶txtæ ¼å¼çš„çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œæ­¤ç±»æ–‡ä»¶æ²¡æœ‰æ—¶é—´æˆ³ä¿¡æ¯ã€‚

**æ—¶é—´æˆ³å¤„ç†**ï¼š
- å¦‚æœå­—å¹•æ–‡ä»¶åŒ…å«æ—¶é—´æˆ³ï¼Œä¸¥æ ¼ä½¿ç”¨[MM:SS.mm]æ ¼å¼ï¼Œå¦‚[01:23.45]ã€[00:23.45]
- åˆ†é’Ÿæ•°å³ä½¿ä¸º0ä¹Ÿè¦ä¿ç•™ï¼Œå¦‚[00:23.45]
- ç§’å’Œæ¯«ç§’ä¹‹é—´ä½¿ç”¨è‹±æ–‡å¥ç‚¹"."åˆ†éš”
- å¦‚æœæ˜¯txtæ ¼å¼æ²¡æœ‰æ—¶é—´æˆ³ï¼Œåˆ™ä¸æ·»åŠ æ—¶é—´æˆ³æ ‡è®°

## æŠ€æœ¯è§„èŒƒè¦æ±‚

**YAMLå‰ç½®å…ƒæ•°æ®**ï¼š
- ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šæ ¼å¼ï¼Œæ¯ä¸ªå­—æ®µåé¢å¿…é¡»æœ‰ç©ºæ ¼
- titleå­—æ®µä½¿ç”¨ã€ç§‘ç›®ã€‘æ¦‚å¿µåæ ¼å¼
- aliasesç¬¬ä¸€ä¸ªåˆ«åå¿…é¡»æ˜¯å»æ‰ç§‘ç›®å‰ç¼€çš„æ¦‚å¿µå
- tagsä½¿ç”¨æ•°ç»„æ ¼å¼ï¼Œä¸éœ€è¦#å·å‰ç¼€
- æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å¿…é¡»åŒ…å«

**åŒé“¾å¼•ç”¨è§„èŒƒ**ï¼š
- å¼•ç”¨å…¶ä»–æ¦‚å¿µæ—¶ä½¿ç”¨[[ã€ç§‘ç›®ã€‘æ¦‚å¿µå|æ¦‚å¿µåï¼ˆæˆ–è€…åˆ«åï¼‰]]æ ¼å¼
- æ˜¾ç¤ºæ–‡æœ¬ä½¿ç”¨ï¼ˆæˆ–åˆ«åï¼‰ï¼ˆæ— ç§‘ç›®å‰ç¼€ï¼‰
- é“¾æ¥ç›®æ ‡ä½¿ç”¨å®Œæ•´æ ‡é¢˜ï¼ˆå«ç§‘ç›®å‰ç¼€ï¼‰
- è¦å»ºç«‹æœ‰æ„ä¹‰çš„åŒé“¾å…³ç³»ï¼Œé¿å…æ— å…³è”çš„éšæ„é“¾æ¥

**ç¬”è®°ç»“æ„è¦æ±‚**ï¼š
- æ¯ä¸ªç¬”è®°éƒ½å¿…é¡»åŒ…å«"æ ¸å¿ƒå®šä¹‰"ã€"è®°å¿†è¦ç‚¹"å’Œ"ç›¸å…³æ¦‚å¿µ"ä¸‰ä¸ªç« èŠ‚
- "è®°å¿†è¦ç‚¹"ç« èŠ‚è¦æ ¹æ®ç¬”è®°å†…å®¹å’Œè€å¸ˆè®²è¯¾é‡ç‚¹ï¼Œæç‚¼å‡ºä¾¿äºè®°å¿†çš„å…³é”®ä¿¡æ¯ï¼Œä½¿ç”¨æ°å½“çš„emojiç¬¦å·
- å…¶ä»–ç« èŠ‚å®Œå…¨æ ¹æ®å†…å®¹éœ€è¦è‡ªç”±åˆ›é€ 
- ç« èŠ‚æ ‡é¢˜è¦å‡†ç¡®åæ˜ å†…å®¹ï¼Œä¾¿äºå¿«é€Ÿå®šä½ä¿¡æ¯
- ç¬”è®°å†…å®¹è¦è¯¦ç»†ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
  - æ ¸å¿ƒå®šä¹‰è¦å‡†ç¡®ã€æ¸…æ™°ã€ç®€æ´
  - è®°å¿†è¦ç‚¹è¦çªå‡ºé‡ç‚¹ã€æ–¹ä¾¿è®°å¿†
  - ç›¸å…³æ¦‚å¿µè¦å®Œæ•´ã€å‡†ç¡®ã€æœ‰æ„ä¹‰
  - æ¡ˆä¾‹æˆ–è€…ç¤ºä¾‹è¦è¯¦ç»†ã€æ¸…æ™°ã€æœ‰æ•ˆ

**åˆ†éš”ç¬¦ä½¿ç”¨**ï¼š
- ä½¿ç”¨ === NOTE_SEPARATOR === åˆ†éš”ä¸åŒçš„ç¬”è®°
- åˆ†éš”ç¬¦å‰åè¦æœ‰ç©ºè¡Œ

## å†…å®¹ç»„ç»‡è‡ªç”±åº¦

é™¤äº†ä¸Šè¿°å›ºå®šæŠ€æœ¯è¦æ±‚å¤–ï¼Œä½ æ‹¥æœ‰å®Œå…¨çš„è‡ªç”±æ¥ï¼š
- åˆ›é€ æœ€åˆé€‚çš„ç« èŠ‚æ ‡é¢˜ï¼Œæ ¹æ®å†…å®¹ç‰¹ç‚¹è®¾è®¡ç« èŠ‚åç§°
- å†³å®šç« èŠ‚æ•°é‡å’Œè¯¦ç•¥ç¨‹åº¦ï¼Œé‡è¦å†…å®¹è¯¦å†™ï¼Œæ¬¡è¦å†…å®¹é€‚åº¦æ¦‚æ‹¬
- è°ƒæ•´ä¿¡æ¯é‡ç‚¹å’Œå±‚æ¬¡ç»“æ„ï¼ŒæŠŠæœ€é‡è¦çš„ä¿¡æ¯æ”¾åœ¨æ˜¾çœ¼ä½ç½®
- é€‰æ‹©æœ€æœ‰åˆ©äºç†è§£çš„ç»„ç»‡æ–¹å¼ï¼Œä½¿ç”¨åˆ—è¡¨ã€å¼•ç”¨ã€åˆ†çº§æ ‡é¢˜ç­‰
- è®¾è®¡ä¿¡æ¯å±•ç¤ºæ–¹å¼ï¼Œå¦‚æ¡ˆä¾‹åˆ†æã€è¦ç‚¹åˆ—ä¸¾ã€å¯¹æ¯”è¯´æ˜ç­‰

## è®°å¿†è¦ç‚¹è®¾è®¡æŒ‡å¯¼

**è®°å¿†è¦ç‚¹ç« èŠ‚**æ˜¯æ¯ä¸ªç¬”è®°çš„å¿…éœ€éƒ¨åˆ†ï¼Œç”¨äºæç‚¼æœ€å…³é”®çš„è®°å¿†ä¿¡æ¯ï¼š

**è®¾è®¡åŸåˆ™**ï¼š
- åŸºäºè€å¸ˆçš„è®²è¯¾é‡ç‚¹å’Œå¼ºè°ƒå†…å®¹
- ä½¿ç”¨ç®€æ´æœ‰åŠ›çš„è¡¨è¿°ï¼Œä¾¿äºå¿«é€Ÿè®°å¿†
- çªå‡ºæ¦‚å¿µçš„æ ¸å¿ƒç‰¹å¾å’Œå…³é”®åŒºåˆ«ç‚¹
- åŒ…å«å…¸å‹åº”ç”¨åœºæ™¯æˆ–è€ƒè¯•è¦ç‚¹

**è¡¨è¿°æ–¹å¼**ï¼š
- ä½¿ç”¨æ°å½“çš„emojiç¬¦å·å¢å¼ºè§†è§‰è®°å¿†
- é‡‡ç”¨ã€Œå…³é”®è¯â†’æ ¸å¿ƒå«ä¹‰ã€çš„ç®€æ´æ ¼å¼
- å¯ä»¥ä½¿ç”¨å£è¯€ã€å¯¹æ¯”ã€åœºæ™¯æè¿°ç­‰è®°å¿†æŠ€å·§
- é•¿åº¦æ§åˆ¶åœ¨1-3è¡Œï¼Œä¾¿äºå¿«é€Ÿæµè§ˆ

**å¸¸ç”¨emojiæŒ‡å¼•**ï¼š
- ğŸ”® ç”¨äºæ ¸å¿ƒæ¦‚å¿µæˆ–åŸç†æ€§å†…å®¹
- ğŸ“± ç”¨äºå…¸å‹åœºæ™¯æˆ–å®é™…åº”ç”¨
- ğŸ’¡ ç”¨äºé‡è¦æé†’æˆ–æ˜“é”™ç‚¹
- âš–ï¸ ç”¨äºæ³•å¾‹åŸåˆ™æˆ–åˆ¤æ–­æ ‡å‡†
- ğŸ¯ ç”¨äºè€ƒè¯•é‡ç‚¹æˆ–ç­”é¢˜è¦ç‚¹
- âš ï¸ ç”¨äºæ³¨æ„äº‹é¡¹æˆ–ä¾‹å¤–æƒ…å†µ

## è´¨é‡æ§åˆ¶è¦ç‚¹

- ç¡®ä¿æ¯ä¸ªç¬”è®°éƒ½èƒ½æˆä¸ºçŸ¥è¯†å›¾è°±ä¸­æœ‰ä»·å€¼çš„èŠ‚ç‚¹
- åŒé“¾å…³ç³»è¦å‡†ç¡®åæ˜ æ¦‚å¿µé—´çš„é€»è¾‘è”ç³»
- é¿å…å­¤ç«‹èŠ‚ç‚¹ï¼Œæ¯ä¸ªæ¦‚å¿µéƒ½è¦ä¸ç›¸å…³æ¦‚å¿µå»ºç«‹åˆç†è¿æ¥

**å®ç”¨æ€§è´¨é‡**ï¼š
- æ¦‚å¿µé¢—ç²’åº¦è¦é€‚åˆé”™é¢˜æ•´ç†çš„éœ€è¦
- æ ‡ç­¾å’Œåˆ†ç±»è¦æ”¯æŒå¤šè§’åº¦æ£€ç´¢
- å†…å®¹ç»„ç»‡è¦ä¾¿äºå¿«é€Ÿå®šä½å’Œç†è§£

## åˆ†æå’Œå¤„ç†å»ºè®®

1. **å…ˆç†è§£å†æ•´ç†**ï¼šä»”ç»†åˆ†æè€å¸ˆçš„è®²è¯¾å†…å®¹å’Œé‡ç‚¹ï¼Œç†è§£çŸ¥è¯†ç‚¹çš„æ ¸å¿ƒä»·å€¼
2. **ä»¥ç†è§£ä¸ºç›®æ ‡**ï¼šæ€è€ƒä»€ä¹ˆæ ·çš„ç»„ç»‡æ–¹å¼æœ€æœ‰åŠ©äºå­¦ç”Ÿç†è§£å’Œè®°å¿†
3. **ä¿ç•™æ•™å­¦ç‰¹è‰²**ï¼šå¦‚æœè€å¸ˆå–„äºä¸¾ä¾‹ï¼Œå°±é‡ç‚¹ä¿ç•™ä¾‹å­ï¼›å¦‚æœå–„äºå¯¹æ¯”ï¼Œå°±çªå‡ºå¯¹æ¯”
4. **å°Šé‡å†…å®¹ç‰¹ç‚¹**ï¼šæœ‰äº›æ¦‚å¿µé€‚åˆé€å±‚æ·±å…¥ï¼Œæœ‰äº›é€‚åˆè¦ç‚¹åˆ—ä¸¾ï¼Œæœ‰äº›é€‚åˆæ¡ˆä¾‹è¯´æ˜
5. **åˆ›é€ æœ‰æ„ä¹‰çš„ç»“æ„**ï¼šç« èŠ‚æ ‡é¢˜è¦å‡†ç¡®åæ˜ å†…å®¹ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½ä¿¡æ¯

## è¾“å‡ºæ ¼å¼æ¨¡æ¿

=== NOTE_SEPARATOR ===
YAML:
---
title: "ã€{metadata['subject']}ã€‘å…·ä½“æ¦‚å¿µå"
aliases: ["å…·ä½“æ¦‚å¿µå", "ç›¸å…³åˆ«å"]
tags: ["{metadata['subject']}", "ç« èŠ‚åç§°", "çŸ¥è¯†ç‚¹ç±»å‹", "é‡è¦ç¨‹åº¦"]
source: "{metadata['source']}"
course_url: "{metadata.get('course_url', '')}"
time_range: "å¼€å§‹æ—¶é—´-ç»“æŸæ—¶é—´"
subject: "{metadata['subject']}"
exam_importance: "é«˜/ä¸­/ä½"
created: "{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
---

CONTENT:
# ã€{metadata['subject']}ã€‘å…·ä½“æ¦‚å¿µå

## æ ¸å¿ƒå®šä¹‰

â° [MM:SS.mm]ï¼ˆå¦‚æœæœ‰æ—¶é—´æˆ³ï¼‰
[å‡†ç¡®çš„å®šä¹‰ï¼Œä¿ç•™è€å¸ˆçš„é‡è¦è¡¨è¿°]

[æ ¹æ®å®é™…å†…å®¹æ™ºèƒ½åˆ›é€ æœ€åˆé€‚çš„ç« èŠ‚ç»“æ„]
[ç« èŠ‚æ ‡é¢˜å®Œå…¨ç”±ä½ æ ¹æ®å†…å®¹å†³å®š]
[å¯ä»¥æ˜¯ä»»ä½•æœ‰åŠ©äºç†è§£çš„ç»„ç»‡æ–¹å¼]

## è®°å¿†è¦ç‚¹

ğŸ”® [å…³é”®è®°å¿†ç‚¹1] â€” [ç®€æ´è§£é‡Šæˆ–è®°å¿†æŠ€å·§]
ğŸ“± [å…³é”®è®°å¿†ç‚¹2] â€” [å…¸å‹åœºæ™¯æˆ–åº”ç”¨æç¤º]
ğŸ’¡ [å…³é”®è®°å¿†ç‚¹3] â€” [é‡è¦æé†’æˆ–æ˜“é”™ç‚¹]

## ç›¸å…³æ¦‚å¿µ

- [[ã€{metadata['subject']}ã€‘ç›¸å…³æ¦‚å¿µ1/åˆ«å1]]
- [[ã€{metadata['subject']}ã€‘ç›¸å…³æ¦‚å¿µ2/åˆ«å2]]
- [[ã€{metadata['subject']}ã€‘ç›¸å…³æ¦‚å¿µ3/åˆ«å3]]

---
*è§†é¢‘æ—¶é—´æ®µï¼š[å¼€å§‹æ—¶é—´]-[ç»“æŸæ—¶é—´]*ï¼ˆå¦‚æœæœ‰æ—¶é—´æˆ³ï¼‰

=== NOTE_SEPARATOR ===

è¯·å¼€å§‹åˆ†æå­—å¹•å†…å®¹ã€‚è®°ä½ï¼šä½ æ­£åœ¨ä¸ºæ³•è€ƒçŸ¥è¯†å›¾è°±åˆ›å»ºèŠ‚ç‚¹ï¼Œä¸ºæ³•è€ƒWikiåˆ›å»ºæ¡ç›®ï¼Œä¸ºé”™é¢˜æ•´ç†ç³»ç»Ÿåˆ›å»ºçŸ¥è¯†ç‚¹ç´¢å¼•ã€‚æ¯ä¸ªç¬”è®°éƒ½è¦è¾¾åˆ°è¿™ä¸‰ä¸ªç›®æ ‡çš„è¦æ±‚ã€‚å€¾å‘äºè¶…ç»†åŒ–æ‹†åˆ†ï¼Œä¸ºæ¯ä¸ªç‹¬ç«‹æ¦‚å¿µåˆ›å»ºå®Œæ•´è€Œè¯¦ç»†çš„ç¬”è®°ã€‚æ— è®ºå¦‚ä½•ï¼Œåœ¨å°†å…¨éƒ¨å­—å¹•è½¬æ¢æˆç¬”è®°ä¹‹å‰ï¼Œè¯·ä¸è¦åœæ­¢è¾“å‡ºï¼Œå¹¶ä¸”ä¸¥æ ¼æŒ‰ç…§æ ¼å¼è¾“å‡ºï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–è¯´æ˜ï¼š"""
    
    def _build_enhancement_prompt(self, all_notes: List[Dict], existing_concepts: Dict) -> str:
        """æ„å»ºæ¦‚å¿µå…³ç³»å¢å¼ºæç¤ºè¯"""
        notes_summary = "\n".join([f"- {note['yaml']['title']}" for note in all_notes])
        existing_concepts_list = existing_concepts.get('existing_concepts', [])
        
        return f"""ä½ æ˜¯æ³•è€ƒçŸ¥è¯†ä½“ç³»ä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹æ–°ç”Ÿæˆçš„ç¬”è®°ï¼Œä¼˜åŒ–å…¶æ¦‚å¿µå…³ç³»é“¾æ¥ã€‚

æ–°ç”Ÿæˆçš„ç¬”è®°ï¼š
{notes_summary}

ç°æœ‰æ¦‚å¿µåº“ä¸­çš„æ¦‚å¿µï¼š
{existing_concepts_list[:50]}  # é™åˆ¶é•¿åº¦

è¦æ±‚ï¼š
1. æ£€æŸ¥æ¯ä¸ªç¬”è®°ä¸­çš„[[æ¦‚å¿µ]]é“¾æ¥æ˜¯å¦å‡†ç¡®ï¼ˆæ ¼å¼ä¸º[[ã€ç§‘ç›®ã€‘æ¦‚å¿µå|æ¦‚å¿µåï¼ˆæˆ–è€…åˆ«åï¼‰]]ï¼‰
2. è¡¥å……å¯èƒ½é—æ¼çš„é‡è¦æ¦‚å¿µå…³è”
3. ç¡®ä¿é“¾æ¥çš„æ¦‚å¿µç¡®å®å­˜åœ¨æˆ–åº”è¯¥å­˜åœ¨
4. ç§»é™¤æ— å…³æˆ–é”™è¯¯çš„æ¦‚å¿µé“¾æ¥
5. åªè¿”å›éœ€è¦ä¿®æ”¹çš„ç¬”è®°çš„æ¦‚å¿µé“¾æ¥éƒ¨åˆ†

è¾“å‡ºæ ¼å¼ï¼š
ENHANCEMENT:
ç¬”è®°æ ‡é¢˜1:
- [[ã€ç§‘ç›®ã€‘ä¿®æ­£åçš„æ¦‚å¿µ1|ä¿®æ­£åçš„æ¦‚å¿µ1ï¼ˆæˆ–è€…åˆ«åï¼‰]]
- [[ã€ç§‘ç›®ã€‘ä¿®æ­£åçš„æ¦‚å¿µ2|ä¿®æ­£åçš„æ¦‚å¿µ2ï¼ˆæˆ–è€…åˆ«åï¼‰]]

ç¬”è®°æ ‡é¢˜2:
- [[ã€ç§‘ç›®ã€‘ä¿®æ­£åçš„æ¦‚å¿µ1|ä¿®æ­£åçš„æ¦‚å¿µ1ï¼ˆæˆ–è€…åˆ«åï¼‰]]
- [[ã€ç§‘ç›®ã€‘ä¿®æ­£åçš„æ¦‚å¿µ2|ä¿®æ­£åçš„æ¦‚å¿µ2ï¼ˆæˆ–è€…åˆ«åï¼‰]]

å¦‚æœæŸä¸ªç¬”è®°ä¸éœ€è¦ä¿®æ”¹ï¼Œä¸è¦åŒ…å«åœ¨è¾“å‡ºä¸­ã€‚"""
    
    def _build_single_note_enhancement_prompt(self, note_content: str, note_title: str, existing_concepts: Dict) -> str:
        """æ„å»ºå•ä¸ªç¬”è®°å¢å¼ºçš„æç¤ºè¯"""
        existing_concepts_list = existing_concepts.get('existing_concepts', [])
        
        return f"""ä½ æ˜¯æ³•è€ƒçŸ¥è¯†ä½“ç³»ä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹ç¬”è®°ï¼Œæ£€æŸ¥å¹¶ä¼˜åŒ–å…¶æ¦‚å¿µå…³ç³»é“¾æ¥ã€‚

ç¬”è®°æ ‡é¢˜ï¼š{note_title}

ç¬”è®°å†…å®¹ï¼š
{note_content}

ç°æœ‰æ¦‚å¿µåº“ï¼ˆå‰100ä¸ªï¼‰ï¼š
{existing_concepts_list[:100]}

è¦æ±‚ï¼š
1. æ£€æŸ¥ç¬”è®°ä¸­ç°æœ‰çš„[[æ¦‚å¿µ]]é“¾æ¥æ˜¯å¦å‡†ç¡®ï¼ˆæ ¼å¼ä¸º[[ã€ç§‘ç›®ã€‘æ¦‚å¿µå|æ¦‚å¿µåï¼ˆæˆ–è€…åˆ«åï¼‰]]ï¼‰
2. è¯†åˆ«ç¬”è®°ä¸­å¯èƒ½é—æ¼çš„é‡è¦æ¦‚å¿µå…³è”
3. åªæ·»åŠ ç¡®å®å­˜åœ¨äºæ¦‚å¿µåº“ä¸­çš„æ¦‚å¿µé“¾æ¥
4. ç§»é™¤æŒ‡å‘ä¸å­˜åœ¨æ¦‚å¿µçš„é“¾æ¥
5. ç¡®ä¿æ–°å¢çš„æ¦‚å¿µé“¾æ¥ä¸ç¬”è®°å†…å®¹é«˜åº¦ç›¸å…³
6. åŒé“¾æ ¼å¼è¦æ±‚ï¼šå¦‚æœæ¦‚å¿µåæœ‰ã€ç§‘ç›®ã€‘å‰ç¼€ï¼Œä½¿ç”¨æ˜¾ç¤ºåˆ«åæ ¼å¼ï¼š[[ã€ç§‘ç›®ã€‘æ¦‚å¿µå|æ¦‚å¿µåï¼ˆæˆ–è€…åˆ«åï¼‰]]
7. ä¸è¦æ·»åŠ ä»»ä½•ä¼˜åŒ–è¯´æ˜æˆ–é¢å¤–å†…å®¹
8. [æ—¶é—´æˆ³]å¿…é¡»ä¸¥æ ¼ä½¿ç”¨[MM:SS.mm]([åˆ†:ç§’.æ¯«ç§’])æ ¼å¼ï¼Œä»»ä½•ä¸€ä½éƒ½ä¸èƒ½çœç•¥ã€‚å¦‚[01:23.45]ï¼Œå¦‚æœåˆ†é’Ÿæ•°ä¸º0ï¼Œè¦ä¿ç•™ï¼Œå¦‚[00:23.45]ï¼›ç§’å’Œæ¯«ç§’ä¹‹é—´ä½¿ç”¨è‹±æ–‡å¥ç‚¹"."


å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œè¯·è¾“å‡ºï¼š
MODIFIED: true
ENHANCED_CONTENT:
[ä¿®æ”¹åçš„å®Œæ•´ç¬”è®°å†…å®¹]

å¦‚æœä¸éœ€è¦ä¿®æ”¹ï¼Œè¯·è¾“å‡ºï¼š
MODIFIED: false

è¯·å¼€å§‹åˆ†æï¼Œä¸è¦æ·»åŠ ä»»ä½•è¯´æ˜ï¼š"""
    
    def _parse_ai_response(self, response_content: str) -> List[Dict[str, Any]]:
        """è§£æAIè¿”å›çš„å¤šä¸ªç¬”è®°æ•°æ®"""
        notes = []
        sections = response_content.split('=== NOTE_SEPARATOR ===')
        
        for section in sections:
            if section.strip():
                note_data = self._parse_single_note(section)
                if note_data:
                    notes.append(note_data)
        
        return notes
    
    def _parse_single_note(self, section: str) -> Optional[Dict[str, Any]]:
        """è§£æå•ä¸ªç¬”è®°çš„YAMLå’Œå†…å®¹"""
        try:
            # æŸ¥æ‰¾YAMLå’ŒCONTENTéƒ¨åˆ†
            yaml_start = section.find('YAML:')
            content_start = section.find('CONTENT:')
            
            if yaml_start == -1 or content_start == -1:
                return None
            
            yaml_section = section[yaml_start + 5:content_start].strip()
            content_section = section[content_start + 8:].strip()
            
            # è§£æYAML
            yaml_content = yaml_section.replace('---', '').strip()
            # å°è¯•ä¿®å¤å¸¸è§çš„YAMLæ ¼å¼é—®é¢˜ï¼šç¡®ä¿å†’å·åæœ‰ç©ºæ ¼
            # åŒ¹é…è¡Œé¦–çš„é”®åï¼Œåé¢ç´§è·Ÿå†’å·å’Œéç©ºç™½å­—ç¬¦ï¼Œå¹¶åœ¨å†’å·åæ·»åŠ ç©ºæ ¼
            yaml_content = re.sub(r'^(?P<key>\s*\S+?):(?P<value>\S.*)', r'\g<key>: \g<value>', yaml_content, flags=re.MULTILINE)
            yaml_data = yaml.safe_load(yaml_content)
            
            return {
                'yaml': yaml_data,
                'content': content_section
            }
        except Exception as e:
            print(f"âš ï¸ è§£æç¬”è®°æ—¶å‡ºé”™: {e}")
            return None
    
    def _parse_enhancement_response(self, response: str, original_notes: List[Dict]) -> List[Dict]:
        """è§£ææ¦‚å¿µå¢å¼ºå“åº”å¹¶åº”ç”¨åˆ°åŸå§‹ç¬”è®°"""
        try:
            # æå–å¢å¼ºéƒ¨åˆ†
            enhancement_start = response.find('ENHANCEMENT:')
            if enhancement_start == -1:
                return original_notes
            
            enhancement_content = response[enhancement_start + 12:].strip()
            
            # è§£æå¢å¼ºå»ºè®®
            enhancements = {}
            current_title = None
            
            for line in enhancement_content.split('\n'):
                line = line.strip()
                if line.endswith(':') and not line.startswith('-'):
                    current_title = line[:-1]
                    enhancements[current_title] = []
                elif line.startswith('- [[') and current_title:
                    concept = re.findall(r'\[\[(.*?)\]\]', line)
                    if concept:
                        enhancements[current_title].append(f"[[{concept[0]}]]")
            
            # åº”ç”¨å¢å¼ºåˆ°åŸå§‹ç¬”è®°
            enhanced_notes = []
            for note in original_notes:
                title = note['yaml']['title']
                if title in enhancements:
                    # æ›´æ–°ç›¸å…³æ¦‚å¿µéƒ¨åˆ†
                    content = note['content']
                    # æ›¿æ¢ç›¸å…³æ¦‚å¿µéƒ¨åˆ†
                    concept_pattern = r'## ç›¸å…³æ¦‚å¿µ\n(.*?)(?=\n##|\n---|\Z)'
                    new_concepts = '\n'.join(f"- {concept}" for concept in enhancements[title])
                    content = re.sub(concept_pattern, f'## ç›¸å…³æ¦‚å¿µ\n{new_concepts}', content, flags=re.DOTALL)
                    note['content'] = content
                
                enhanced_notes.append(note)
            
            return enhanced_notes
        except Exception as e:
            print(f"âš ï¸ åº”ç”¨æ¦‚å¿µå¢å¼ºæ—¶å‡ºé”™: {e}")
            return original_notes
    
    def _parse_single_note_enhancement_response(self, response: str, original_content: str) -> Optional[Dict]:
        """è§£æå•ä¸ªç¬”è®°å¢å¼ºå“åº”"""
        try:
            if "MODIFIED: true" in response:
                content_start = response.find("ENHANCED_CONTENT:")
                if content_start != -1:
                    enhanced_content = response[content_start + 17:].strip()
                    
                    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å¤„ç†å¯èƒ½çš„ä»£ç å—åŒ…è£¹ï¼ˆæ”¯æŒè¯­è¨€æ ‡ç­¾ï¼‰
                    # åŒ¹é…å¼€å¤´ï¼š```åè·Ÿå¯é€‰çš„è¯­è¨€åç§°
                    # åŒ¹é…ç»“å°¾ï¼š```å¯èƒ½å‰åæœ‰ç©ºç™½
                    code_block_pattern = re.compile(
                        r'^\s*```[a-zA-Z0-9_+-]*\s*\n?(.*?)\s*```\s*$', 
                        re.DOTALL
                    )
                    
                    match = code_block_pattern.match(enhanced_content)
                    if match:
                        # æå–ä»£ç å—å†…å®¹
                        enhanced_content = match.group(1).strip()
                    else:
                        # å¤„ç†åªæœ‰å¼€å¤´æ ‡è®°çš„æƒ…å†µ
                        if enhanced_content.startswith('```'):
                            # ç§»é™¤å¼€å¤´çš„```å’Œå¯èƒ½å­˜åœ¨çš„è¯­è¨€åç§°
                            enhanced_content = re.sub(r'^\s*```[a-zA-Z0-9_+-]*\s*', '', enhanced_content, 1)
                        
                        # å¤„ç†ç»“å°¾æ ‡è®°
                        if enhanced_content.endswith('```'):
                            enhanced_content = re.sub(r'\s*```\s*$', '', enhanced_content)
                        
                        # ç¡®ä¿å»é™¤å¤šä½™ç©ºç™½
                        enhanced_content = enhanced_content.strip()
                    
                    return {
                        'modified': True,
                        'enhanced_content': enhanced_content
                    }
            
            return {'modified': False}
            
        except Exception as e:
            print(f"âš ï¸ è§£æå¢å¼ºå“åº”å¤±è´¥: {e}")
            return None